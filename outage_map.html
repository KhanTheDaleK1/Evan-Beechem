<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>OPENEYES // SENTINEL</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --term-green: #00ff00; --term-red: #ff3333; --bg-color: #0d0d0d; --font-stack: 'Courier New', monospace; }
        body { margin: 0; background: var(--bg-color); color: var(--term-green); font-family: var(--font-stack); overflow: hidden; }
        canvas#matrix { position: fixed; top: 0; left: 0; z-index: -1; opacity: 0.15; }
        #ui-container { position: relative; width: 100vw; height: 100vh; display: grid; grid-template-rows: 60px 1fr 250px; }
        header { display: flex; justify-content: space-between; align-items: center; padding: 0 20px; border-bottom: 2px solid var(--term-green); background: rgba(0, 20, 0, 0.9); z-index: 10; }
        h1 { font-size: 1.5rem; letter-spacing: 2px; margin: 0; text-shadow: 0 0 5px var(--term-green); }
        .back-btn { text-decoration: none; color: black; background: var(--term-green); padding: 5px 15px; font-weight: bold; }
        #map { width: 100%; height: 100%; background: black; }
        .leaflet-tile-pane { filter: invert(100%) sepia(100%) hue-rotate(70deg) saturate(300%) contrast(110%) brightness(1.5); }
        .leaflet-marker-icon, .leaflet-popup-content-wrapper, .leaflet-overlay-pane { filter: none !important; }
        footer { background: rgba(0, 10, 0, 0.95); border-top: 2px solid var(--term-green); padding: 0; z-index: 10; display: grid; grid-template-columns: 2fr 1fr 1fr; }
        .panel { padding: 10px; overflow-y: auto; border-right: 1px solid #004400; }
        h3 { margin: 0 0 10px 0; border-bottom: 1px dashed #004400; font-size: 0.9rem; color: #88ff88; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        td { padding: 4px; border-bottom: 1px solid #004400; }
        .sparkline { width: 50px; height: 15px; display: inline-block; vertical-align: middle; border-bottom: 1px solid #004400; }
        .bar { display: inline-block; width: 4px; background: var(--term-green); margin-right: 1px; }
        .status-ok { color: #0f0; }
        .status-fail { color: #f00; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } }
    </style>
</head>
<body>
    <canvas id="matrix"></canvas>
    <div id="ui-container">
        <header>
            <h1>// SENTINEL // NETWORK INTELLIGENCE</h1>
            <a href="index.html" class="back-btn">[ RETURN ]</a>
        </header>
        <div id="map-wrapper"><div id="map"></div></div>
        <footer>
            <div class="panel">
                <h3>NETWORK BACKBONE (PING/TRACE)</h3>
                <table id="net-table"></table>
            </div>
            <div class="panel">
                <h3>CRITICAL SERVICES (HTTP/SSL)</h3>
                <table id="svc-table"></table>
            </div>
            <div class="panel">
                <h3>USER EXPERIENCE (SYNTH)</h3>
                <table id="syn-table"></table>
            </div>
        </footer>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map', { zoomControl: false }).setView([20, 0], 2);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);

        async function updateData() {
            try {
                // 1. Fetch Outages (News)
                const resOut = await fetch('live_outages.json?v=' + Date.now());
                const outages = await resOut.json();
                map.eachLayer(l => { if(l instanceof L.CircleMarker) map.removeLayer(l); });
                outages.forEach(a => {
                    L.circleMarker(a.coords, { color: '#f00', radius: 8, fillOpacity: 0.8 }).addTo(map)
                     .bindPopup(`<b>${a.isp} OUTAGE</b><br>${a.loc}`);
                });

                // 2. Fetch Sentinel Data (Health)
                const resNet = await fetch('network_health.json?v=' + Date.now());
                const health = await resNet.json();
                
                // RENDER NETWORK
                const netTable = document.getElementById('net-table');
                netTable.innerHTML = '<tr><th>TARGET</th><th>STATUS</th><th>LATENCY</th><th>JITTER</th><th>TREND</th></tr>';
                health.network.forEach(n => {
                    const isUp = n.status === "ONLINE";
                    const color = isUp ? "#0f0" : "#f00";
                    L.polyline([n.origin, n.dest], { color: color, weight: 1, opacity: 0.5 }).addTo(map);
                    L.circleMarker(n.dest, { color: color, radius: 4 }).addTo(map);
                    let spark = "";
                    if(n.history) n.history.forEach(h => { let hPct = Math.min(100, h) / 2; spark += `<span class="bar" style="height:${hPct}px;"></span>`; });
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${n.name}</td><td class="${isUp?'status-ok':'status-fail'}">${n.status}</td><td>${n.latency}ms</td><td>${n.jitter.toFixed(1)}ms</td><td><div class="sparkline">${spark}</div></td>`;
                    netTable.appendChild(row);
                });

                // RENDER SERVICES
                const svcTable = document.getElementById('svc-table');
                svcTable.innerHTML = '<tr><th>SERVICE</th><th>STATUS</th><th>SSL</th></tr>';
                health.services.forEach(s => {
                    // FILTER OUT AVIATION
                    if(s.name.includes("PLANESPOTTERS") || s.name.includes("AIRPLANES.LIVE")) return;

                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${s.name}</td><td class="${s.status=='ONLINE'?'status-ok':'status-fail'}">${s.status} (${s.code})</td><td>${s.ssl} DAYS</td>`;
                    svcTable.appendChild(row);
                });

                // RENDER SYNTH
                const synTable = document.getElementById('syn-table');
                synTable.innerHTML = '<tr><th>TARGET</th><th>LOAD TIME</th><th>UX STATUS</th></tr>';
                if(health.synthetic) {
                    health.synthetic.forEach(y => {
                        const row = document.createElement('tr');
                        row.innerHTML = `<td>${y.name}</td><td>${y.latency}ms</td><td class="${y.status=='PASS'?'status-ok':'status-fail'}">${y.status}</td>`;
                        synTable.appendChild(row);
                    });
                }

            } catch(e) { console.log("Data Link Offline", e); }
        }

        const c = document.getElementById("matrix"), ctx = c.getContext("2d");
        c.height = window.innerHeight; c.width = window.innerWidth;
        const font_size = 14, columns = c.width/font_size, drops = Array(Math.floor(columns)).fill(1);
        function drawMatrix() {
            ctx.fillStyle = "rgba(0, 0, 0, 0.05)"; ctx.fillRect(0, 0, c.width, c.height);
            ctx.fillStyle = "#0F0"; ctx.font = font_size + "px arial";
            drops.forEach((y, i) => {
                const text = String.fromCharCode(0x30A0 + Math.random() * 96);
                ctx.fillText(text, i*font_size, y*font_size);
                if(y*font_size > c.height && Math.random() > 0.975) drops[i] = 0;
                drops[i]++;
            });
        }
        setInterval(drawMatrix, 33);
        updateData();
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js');
            });
        }
    </script>
</body>
</html>
