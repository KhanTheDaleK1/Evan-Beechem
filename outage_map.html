<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GLOBAL NETWATCH // LIVE</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --term-green: #00ff00; --term-red: #ff3333; --bg-color: #0d0d0d; --font-stack: 'Courier New', monospace; }
        body { margin: 0; background: var(--bg-color); color: var(--term-green); font-family: var(--font-stack); overflow: hidden; }
        canvas#matrix { position: fixed; top: 0; left: 0; z-index: -1; opacity: 0.2; }
        
        #ui-container { position: relative; width: 100vw; height: 100vh; display: grid; grid-template-rows: 60px 1fr 200px; }
        
        header { display: flex; justify-content: space-between; align-items: center; padding: 0 20px; border-bottom: 2px solid var(--term-green); background: rgba(0, 20, 0, 0.9); z-index: 10; }
        h1 { font-size: 1.5rem; letter-spacing: 2px; margin: 0; text-shadow: 0 0 5px var(--term-green); }
        .back-btn { text-decoration: none; color: black; background: var(--term-green); padding: 5px 15px; font-weight: bold; }

        #map { width: 100%; height: 100%; background: black; }
        /* Matrix Filter */
        .leaflet-tile-pane { filter: invert(100%) sepia(100%) hue-rotate(70deg) saturate(300%) contrast(110%) brightness(1.5); }
        .leaflet-marker-icon, .leaflet-popup-content-wrapper { filter: none !important; }

        footer { background: rgba(0, 10, 0, 0.95); border-top: 2px solid var(--term-green); padding: 10px; z-index: 10; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        th { text-align: left; border-bottom: 1px dashed #004400; color: #88ff88; padding: 5px; }
        td { padding: 5px; border-bottom: 1px solid #004400; }
        tr:hover { background: #002200; cursor: crosshair; }
        
        .status-crit { color: var(--term-red); font-weight: bold; animation: blink 1s infinite alternate; }
        @keyframes blink { 0% { opacity: 1; } 100% { opacity: 0.5; } }
        
        /* Custom Popup */
        .leaflet-popup-content-wrapper { background: #000; border: 1px solid var(--term-green); color: var(--term-green); border-radius: 0; font-family: monospace; }
        .leaflet-popup-tip { background: var(--term-green); }
        a.news-link { color: #fff; text-decoration: underline; }
    </style>
</head>
<body>
    <canvas id="matrix"></canvas>
    <div id="ui-container">
        <header>
            <h1>// GLOBAL NETWATCH //</h1>
            <a href="index.html" class="back-btn">[ MAIN MENU ]</a>
        </header>
        <div id="map-wrapper"><div id="map"></div></div>
        <footer>
            <table id="sector-table">
                <thead><tr><th>PROVIDER</th><th>LOCATION</th><th>SEVERITY</th><th>REPORTED</th><th>DETAILS</th></tr></thead>
                <tbody id="table-body"><tr><td colspan="5">INITIALIZING SATELLITE LINK...</td></tr></tbody>
            </table>
        </footer>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // CONFIG
        const map = L.map('map', { zoomControl: false }).setView([30, -10], 2); // World View
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);

        // LIVE DATA FETCH
        async function updateMap() {
            try {
                // Fetch JSON generated by Python Bot
                const res = await fetch('live_outages.json?v=' + Date.now());
                const outages = await res.json();
                
                const table = document.getElementById('table-body');
                table.innerHTML = ''; // Clear old data
                
                // Clear old markers (naive approach: clear all layers except tiles)
                map.eachLayer((layer) => {
                    if (layer instanceof L.CircleMarker) { map.removeLayer(layer); }
                });

                if(outages.length === 0) {
                    table.innerHTML = '<tr><td colspan="5">NO ACTIVE CRITICAL ALERTS</td></tr>';
                    return;
                }

                outages.forEach(alert => {
                    // Draw Marker
                    const color = alert.isp === "Unknown Provider" ? "#ffaa00" : "#ff0000";
                    L.circleMarker(alert.coords, {
                        color: color, fillColor: color, fillOpacity: 0.5, radius: 8
                    }).addTo(map).bindPopup(`
                        <b>${alert.isp} OUTAGE</b><br>
                        ${alert.loc}<br>
                        <a href="${alert.link}" target="_blank" class="news-link">READ REPORT >></a>
                    `);

                    // Add to Table
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${alert.isp}</td>
                        <td>${alert.loc}</td>
                        <td class="status-crit">CRITICAL</td>
                        <td>${new Date(alert.time).toLocaleTimeString()}</td>
                        <td><a href="${alert.link}" target="_blank" style="color:#0f0;">SOURCE</a></td>
                    `;
                    row.addEventListener('click', () => {
                        map.setView(alert.coords, 10);
                    });
                    table.appendChild(row);
                });

            } catch (e) {
                console.log("Data Link Offline", e);
            }
        }

        // MATRIX BG
        const c = document.getElementById("matrix"), ctx = c.getContext("2d");
        c.height = window.innerHeight; c.width = window.innerWidth;
        const font_size = 14, columns = c.width/font_size, drops = Array(Math.floor(columns)).fill(1);
        function drawMatrix() {
            ctx.fillStyle = "rgba(0, 0, 0, 0.05)"; ctx.fillRect(0, 0, c.width, c.height);
            ctx.fillStyle = "#0F0"; ctx.font = font_size + "px arial";
            drops.forEach((y, i) => {
                const text = String.fromCharCode(0x30A0 + Math.random() * 96);
                ctx.fillText(text, i*font_size, y*font_size);
                if(y*font_size > c.height && Math.random() > 0.975) drops[i] = 0;
                drops[i]++;
            });
        }
        setInterval(drawMatrix, 33);
        
        // Start System
        updateMap();
    </script>
</body>
</html>
